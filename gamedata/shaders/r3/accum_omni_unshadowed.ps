#include "common.h"
#include "lmodel.h"

//	TODO: DX10: Move to Load
half4 main ( float4 tc:TEXCOORD0 ) : SV_Target
{
	const half bias_mul 	= 0.999f;

 	// Sample the fat framebuffer:
//	half4 _P		= tex2Dproj 	(s_position, tc); 
//	half4 _N		= tex2Dproj 	(s_normal,   tc); 
	float2	tcProj	= tc.xy / tc.w;
	half4 _P		= s_position.Sample( smp_nofilter, tcProj );
	half4 _N		= s_normal.Sample( smp_nofilter, tcProj );

	half 	m	= xmaterial	;
# ifndef USE_R2_STATIC_SUN
			m 	= _P.w		;
# endif

	half	rsqr;
	half4	light 		= plight_local( m, _P, _N, Ldynamic_pos, Ldynamic_pos.w, rsqr );
	return 	blendp( Ldynamic_color * light, tc);
}
